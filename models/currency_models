# models/currency_models.py
import psycopg2
from psycopg2.extras import RealDictCursor
from config import Config
from models.news_models import init_news_tables
import logging
import os 
from typing import Optional, Any

logger = logging.getLogger(__name__)

def get_db() -> Any:
    """PostgreSQL baÄŸlantÄ±sÄ±nÄ± dÃ¶ner."""
    try:
        # BaÄŸlantÄ± dizesini loglamak iÃ§in gÃ¼venlik amaÃ§lÄ± ÅŸifreyi sansÃ¼rle
        db_url = Config.DATABASE_URL
        if db_url:
            if '@' in db_url:
                # KullanÄ±cÄ± ve ÅŸifre kÄ±smÄ±nÄ± '****' ile deÄŸiÅŸtir
                parts = db_url.split('@')
                user_pass_info = parts[0].split('//')[1]
                log_url = f"{db_url.split('//')[0]}://{user_pass_info.split(':')[0]}:****@{parts[1]}"
            else:
                log_url = db_url
        else:
            log_url = "URL Yok"

        logger.info(f"ğŸ’¾ VeritabanÄ±na baÄŸlanÄ±lÄ±yor... KullanÄ±lan URL (SansÃ¼rlÃ¼): {log_url}") 
        
        # Orijinal URL ile baÄŸlan
        conn = psycopg2.connect(db_url, cursor_factory=RealDictCursor)
        return conn
    except Exception as e:
        logger.error(f"âŒ KRÄ°TÄ°K VeritabanÄ± BaÄŸlantÄ± HatasÄ±: {e}")
        # BaÄŸlantÄ± hatasÄ±nÄ± yakalayÄ±n ve dÄ±ÅŸarÄ± fÄ±rlatÄ±n (Render LoglarÄ±na net dÃ¼ÅŸmesi iÃ§in)
        raise ConnectionError(f"VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±: {e}") 

def init_currency_tables(cursor: Any) -> None:
    """KuraBak tablolarÄ±nÄ± oluÅŸturur."""
    
    # DÃ¶vizler
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS currencies (
            id SERIAL PRIMARY KEY,
            code VARCHAR(10) UNIQUE NOT NULL,
            name VARCHAR(100) NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # DÃ¶viz GeÃ§miÅŸi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS currency_history (
            id SERIAL PRIMARY KEY,
            code VARCHAR(10) NOT NULL,
            rate FLOAT NOT NULL,
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # AltÄ±nlar
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS golds (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            buying FLOAT NOT NULL,
            selling FLOAT NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # AltÄ±n GeÃ§miÅŸi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS gold_history (\
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            rate FLOAT NOT NULL,
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # GÃ¼mÃ¼ÅŸler
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS silvers (\
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            buying FLOAT NOT NULL,
            selling FLOAT NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # GÃ¼mÃ¼ÅŸ GeÃ§miÅŸi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS silver_history (\
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            rate FLOAT NOT NULL,
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Log Tablosu
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS update_logs (
            id SERIAL PRIMARY KEY,
            update_type VARCHAR(50) NOT NULL,
            status VARCHAR(20) NOT NULL,
            message VARCHAR(255),
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Indexler (Performans iÃ§in)
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_currency_code ON currencies(code)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_gold_name ON golds(name)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_silver_name ON silvers(name)')


def init_db() -> bool:
    """TÃ¼m veritabanÄ± tablolarÄ±nÄ± (Haber + Kur) oluÅŸturur."""
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        # news_models.py'den haber tablolarÄ±nÄ± baÅŸlat
        init_news_tables(cursor)
        
        # Kur tablolarÄ±nÄ± baÅŸlat
        init_currency_tables(cursor)
        
        conn.commit()
        cursor.close()
        conn.close()
        logger.info("âœ… VeritabanÄ± (Tablolar) baÅŸarÄ±yla baÅŸlatÄ±ldÄ±.")
        return True
    except ConnectionError:
        # get_db() hatasÄ± burada yakalanÄ±r
        logger.error("âŒ init_db BAÅARISIZ. VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±ÄŸÄ± iÃ§in tablolar oluÅŸturulamadÄ±.")
        return False
    except Exception as e:
        logger.error(f"âŒ init_db sÄ±rasÄ±nda beklenmedik hata: {e}")
        return False
