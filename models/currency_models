# models/currency_models.py
import psycopg2
from psycopg2.extras import RealDictCursor
from config import Config
# Düzeltildi: 'models.' paketi kaldırıldı, doğrudan dosya adı üzerinden import edildi.
from news_models import init_news_tables 
import logging

logger = logging.getLogger(__name__)

def get_db():
    """PostgreSQL bağlantısını döner."""
    try:
        # psycop2'nin kabul ettiği URL formatına dönüştürme (Render'ın sağladığı 'postgres://' yerine 'postgresql://' kullanır)
        db_url = Config.DATABASE_URL.replace("postgres://", "postgresql://", 1)
        conn = psycopg2.connect(db_url, cursor_factory=RealDictCursor)
        return conn
    except Exception as e:
        logger.error(f"❌ Veritabanına bağlanılamadı. Hata: {e}")
        # Bağlantı hatasını yakalayın ve dışarı fırlatın
        raise ConnectionError("Veritabanı bağlantısı kurulamadı.")

def init_currency_tables(cursor):
    """KuraBak tablolarını oluşturur."""
    
    # Dövizler
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS currencies (
            id SERIAL PRIMARY KEY,
            code VARCHAR(10) UNIQUE NOT NULL,
            name VARCHAR(100) NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Döviz Geçmişi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS currency_history (
            id SERIAL PRIMARY KEY,
            code VARCHAR(10) NOT NULL,
            rate FLOAT NOT NULL,
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Altınlar
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS golds (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            buying FLOAT NOT NULL,
            selling FLOAT NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Altın Geçmişi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS gold_history (\
            id SERIAL PRIMARY KEY,\
            name VARCHAR(100) NOT NULL,\
            rate FLOAT NOT NULL,\
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')

    # Gümüşler
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS silvers (
            id SERIAL PRIMARY KEY,
            name VARCHAR(100) UNIQUE NOT NULL,
            buying FLOAT NOT NULL,
            selling FLOAT NOT NULL,
            rate FLOAT NOT NULL,
            updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Gümüş Geçmişi
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS silver_history (\
            id SERIAL PRIMARY KEY,\
            name VARCHAR(100) NOT NULL,\
            rate FLOAT NOT NULL,\
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Log Tablosu
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS update_logs (
            id SERIAL PRIMARY KEY,
            update_type VARCHAR(50) NOT NULL,
            status VARCHAR(20) NOT NULL,
            message VARCHAR(255),
            timestamp TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # Indexler
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_currency_code ON currencies(code)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_gold_name ON golds(name)')
    cursor.execute('CREATE INDEX IF NOT EXISTS idx_silver_name ON silvers(name)')


def init_db():
    """Tüm veritabanı tablolarını (Haber + Kur) oluşturur."""
    if not Config.DATABASE_URL:
        logger.error("❌ DATABASE_URL ortam değişkeni ayarlanmamış.")
        return False
        
    try:
        conn = get_db()
        cursor = conn.cursor()
        
        # news_models.py'den haber tablolarını başlat
        init_news_tables(cursor)
        
        # Kur tablolarını başlat
        init_currency_tables(cursor)
        
        conn.commit()
        cursor.close()
        conn.close()
        logger.info("✅ Veritabanı tabloları kontrol edildi/oluşturuldu.")
        return True
    except ConnectionError:
        # get_db'den gelen özel hata
        return False
    except Exception as e:
        logger.error(f"❌ Veritabanı başlangıç hatası: {e}")
        return False
